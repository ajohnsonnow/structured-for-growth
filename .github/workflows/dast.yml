# P3.2.2 — DAST Scanning with OWASP ZAP
# Runs OWASP ZAP baseline scan against the staging/dev server
# Standard: FedRAMP ConMon, OWASP ASVS, NIST SP 800-53 RA-5

name: DAST — OWASP ZAP

on:
  # Run on pushes to main (after deploy to staging)
  push:
    branches: [main]
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (default: localhost)'
        required: false
        default: 'http://localhost:3000'
      scan_type:
        description: 'Scan type'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  zap-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start application server
        run: |
          npm start &
          sleep 5
          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done
        env:
          NODE_ENV: production
          JWT_SECRET: ci-test-secret-not-for-production
          PORT: 3000

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ inputs.target_url || 'http://localhost:3000' }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: true
          fail_action: true
          artifact_name: 'zap-report'

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 30

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report_json.json
        continue-on-error: true
